language: php

env:
  - MYSQL_USER=travis MYSQL_PASSWORD=''

php:
  - '7.1'
  
services:
  - mysql

addons:
  hosts:
    - doubleloop.dev 
    
before_install:
  # execute all of the commands which need to be executed 
  # before installing dependencies
  - pear config-set preferred_state beta
  - pecl channel-update pecl.php.net
  
install:
  # install all of the dependencies
  - composer install
  - yes | pecl install imagick
  - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
  - chmod +x wp-cli.phar
    
before_script:
  # execute all of the commands which need to be executed 
  # before running actual tests
  - mysql -e 'CREATE DATABASE doubleloop_ci;'
  - ./wp-cli.phar core download --allow-root --path=wordpress
  - ./wp-cli.phar core config --allow-root --dbname=doubleloop_ci --dbuser=travis --dbhost=localhost --path=wordpress
  - ./wp-cli.phar core install --allow-root --admin_name=admin --admin_password=admin --admin_email=admin@example.com --url=http://doubleloop.dev:4040 --title=WordPress --path=wordpress
  - git clone https://github.com/ngm/doublepress.git wordpress/wp-content/themes/doublepress
  - ./wp-cli.phar theme activate doublepress --path=wordpress
  - php -S doubleloop.dev:4040 -t wordpress &
  - phantomjs --webdriver 4444 &
  - sleep 5

script:
  # execute all of the commands which should make the build pass or fail
  - php vendor/codeception/codeception/codecept run acceptance
